import streamlit as st
import pandas as pd
import plotly.graph_objects as go

st.set_page_config(page_title="IDS 완전 초보 안내", layout="wide")
st.title("🛡 네트워크 침입 탐지 시스템 (IDS) 안내 - 문외한도 이해 가능!")

# -----------------------------
# 1. 사이트 목적
# -----------------------------
st.header("1️⃣ 이 사이트는 무엇을 하는 곳인가요?")
st.write("""
- 인터넷이나 회사 네트워크에는 많은 연결이 오갑니다.  
- 그중 일부는 **정상**, 일부는 **위험한 연결**일 수 있습니다.  
- 이 사이트는 **네트워크 경비원**처럼 정상과 이상을 구분합니다.  
- 이상 연결을 발견하면 **빨간 점**으로 표시해 바로 알 수 있습니다.
""")

# -----------------------------
# 2. 마르코프 체인 쉽게 풀기
# -----------------------------
st.header("2️⃣ 마르코프 체인이란?")
st.write("""
- 마르코프 체인은 **앞에 있는 상태만 보고 다음 상태를 예측하는 방법**입니다.  
- 쉽게 말하면, **과거는 무시하고 지금 상태만 기억**하는 규칙입니다.  
- 예시: 날씨  
  - 오늘 맑음 → 내일 맑음 70%, 흐림 20%, 비 10%  
  - 오늘 흐림 → 내일 맑음 40%, 흐림 50%, 비 10%  
  - 오늘 비 → 내일 맑음 20%, 흐림 30%, 비 50%  
- 여기서 **상태 = 오늘 날씨**, **전이확률 = 다음 날 날씨 나올 확률**
""")

st.write("""
- 네트워크 IDS에서는 **현재 연결 상태(flag)만 보고 다음 연결이 정상인지 위험한지 확률로 예측**합니다.  
- 즉, 평소 연결 패턴을 학습하고, **평소와 다른 패턴이 나타나면 경고**를 주는 시스템입니다.
""")

# -----------------------------
# 3. 왜 전이행렬이 필요한가?
# -----------------------------
st.header("3️⃣ 전이행렬이란 무엇일까요?")
st.write("""
- **전이행렬** = 모든 상태에서 다음 상태로 넘어갈 확률을 정리한 표입니다.  
- 행 = 현재 상태, 열 = 다음 상태, 값 = 다음 상태로 넘어갈 확률입니다.  
- 예: 현재 상태가 '정상1'이면, 다음 상태가 '정상1' 40%, '정상2' 30%, '이상' 30%  
- 전이행렬을 보면, 어떤 상태가 자주 나오는지, 어떤 상태가 잘 안 나오는지도 확인할 수 있습니다.
""")

example_matrix = pd.DataFrame(
    [[0.4,0.3,0.3],
     [0.2,0.5,0.3],
     [0.1,0.3,0.6]],
    columns=["정상1","정상2","이상"], index=["정상1","정상2","이상"]
)
st.dataframe(example_matrix)

# -----------------------------
# 4. 그림으로 직관적 이해
# -----------------------------
st.header("4️⃣ 그래프 예시")
st.write("""
- 🟦 파란 점 = 정상 이벤트  
- 🔴 빨간 점 = 위험/이상 이벤트  
- x축 = 연속 이벤트 묶음 번호  
- y축 = 평균 전이 확률  
- 슬라이더로 민감도를 조정하면 빨간 점이 늘어나거나 줄어듭니다.
""")

x = list(range(1,11))
y = [0.9,0.85,0.2,0.95,0.8,0.15,0.88,0.9,0.1,0.92]
colors = ['red' if v<0.3 else 'blue' for v in y]

fig = go.Figure(go.Scatter(
    x=x, y=y,
    mode='markers+lines',
    marker=dict(color=colors, size=12),
    line=dict(color='gray'),
    name='평균 전이 확률'
))
fig.update_layout(title="연속 이벤트 평균 전이 확률 예시",
                  xaxis_title="연속 이벤트 묶음 번호",
                  yaxis_title="평균 전이 확률",
                  yaxis_range=[0,1])
st.plotly_chart(fig, use_container_width=True)

# -----------------------------
# 5. 단계별 이해
# -----------------------------
st.header("5️⃣ 단계별로 한눈에 이해하기")
st.write("""
1. **평소 연결 패턴 학습** → 전이행렬 생성  
2. **새로운 연결 등장** → 전이확률 계산  
3. **평균 전이확률 < 임계값** → 이상 이벤트 표시 (빨간 점)  
4. **그래프와 표 확인** → 어떤 연결이 위험한지 파악
""")

# -----------------------------
# 6. 추가 팁 (expander)
# -----------------------------
with st.expander("💡 추가 팁"):
    st.write("""
- 슬라이더로 민감도를 높이면 빨간 점이 더 많이 나타납니다.  
- 연속 이벤트 길이를 늘리면 탐지 정확도가 올라갑니다.  
- 전이행렬 값이 낮은 경우 → 평소 잘 안 나오던 연결 → 위험 신호
""")

# -----------------------------
# 7. 추가 상세 설명 (보충)
# -----------------------------
st.header("7️⃣ 좀 더 자세히 알아보기")

st.subheader("연속 이벤트란 무엇인가요?")
st.write("""
- 네트워크 연결 하나하나를 **이벤트**라고 부릅니다.  
- 연속으로 발생한 이벤트들을 모으면 **연속 이벤트**라고 부릅니다.  
- 예: 5개의 연결이 순서대로 발생하면, 하나의 연속 이벤트 묶음이 됩니다.  
- 연속 이벤트를 보면, **패턴을 한눈에 확인할 수 있어서 이상도 쉽게 찾아낼 수 있습니다.**
""")

st.subheader("이벤트 묶음 번호(x축)란?")
st.write("""
- 그래프 x축 숫자 1, 2, 3…은 **연속 이벤트 묶음 번호**입니다.  
- 1번 = 첫 번째 묶음, 2번 = 두 번째 묶음, 3번 = 세 번째 묶음 등입니다.  
- 즉, 시간 순서대로 **몇 번째 이벤트 묶음인지 확인할 수 있어서 흐름도 이해할 수 있습니다.**
""")

st.subheader("확률 그래프를 읽는 법")
st.write("""
- y축 = 평균 전이 확률, x축 = 연속 이벤트 묶음 번호입니다.  
- 점이 **파란색**이면 정상, **빨간색**이면 위험 이벤트입니다.  
- 점이 아래쪽으로 내려가면 평소 잘 안 나오는 연결 → 위험 신호로 볼 수 있습니다.  
- 그래프를 보면 **언제 위험 이벤트가 발생했는지도 한눈에 확인할 수 있습니다.**
""")

st.subheader("이벤트 길이란?")
st.write("""
- 연속 이벤트 묶음 안에 포함된 이벤트 수를 **이벤트 길이**라고 합니다.  
- 길이가 길면 한 묶음 안에서 더 많은 연결 패턴을 분석 → 탐지 정확도도 올라갑니다.  
- 길이가 짧으면 빠른 탐지는 가능하지만, 작은 패턴만 보고 판단하게 됩니다.
""")

st.subheader("전이행렬을 읽는 법")
st.write("""
- 전이행렬 = 모든 상태에서 다음 상태로 넘어갈 확률을 정리한 표입니다.  
- 행 = 현재 상태, 열 = 다음 상태, 값 = 다음 상태로 넘어갈 확률입니다.  
- 예: 현재 '정상1'이면 다음 '정상1' 40%, '정상2' 30%, '이상' 30%  
- 전이행렬을 보면 **어떤 상태가 자주 나오는지, 어떤 상태가 잘 안 나오는지도 확인할 수 있습니다.**
""")

st.subheader("탐지 결과 요약 읽는 법")
st.write("""
- 그래프와 전이행렬을 바탕으로, 시스템이 판단한 **정상/위험 이벤트 결과**를 확인할 수 있습니다.  
- 빨간 점 = 위험, 파란 점 = 정상  
- 슬라이더로 민감도를 바꾸면, 위험으로 분류되는 이벤트 수도 변합니다.  
- 요약을 보면 **전체 연결 중 얼마나 위험이 있었는지도 쉽게 이해할 수 있습니다.**
""")
